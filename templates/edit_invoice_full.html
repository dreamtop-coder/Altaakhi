{% extends 'base.html' %}
{% block content %}

<div class="services-table-fix" style="max-width:900px;margin:12px 0 12px auto;background:#f9f9f9;padding:14px 16px;border-radius:10px;box-shadow:0 2px 8px #eee;direction:rtl;">
    <style>
    .services-table-fix { font-size:0.95rem; }
    @media (max-width:900px) { .services-table-fix { padding:12px; } }
    .form-row { margin-bottom:10px; }
    .compact-input { padding:6px;border-radius:6px;border:1px solid #ccc; }
    table.services-compact thead th { padding:8px 8px !important; }
    table.services-compact tbody td { padding:6px 8px !important; }
    </style>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <span style="font-size:18px;font-weight:bold;color:#333;text-align:right;">تعديل الفاتورة وسجلات الصيانة</span>
        <a href="{% url 'invoices_list' %}" style="color:#333;text-decoration:none;font-size:0.95em;">عودة</a>
    </div>

    <form method="post" id="edit-invoice-form">
        {% csrf_token %}
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
            <div style="flex:1;min-width:160px;">
                <label style="display:block;font-weight:600;margin-bottom:6px;">المبلغ</label>
                {{ form.amount }}
            </div>
            <div style="min-width:160px;">
                <label style="display:block;font-weight:600;margin-bottom:6px;">تاريخ الإنشاء</label>
                {{ form.created_at }}
            </div>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:12px 0;" />

        <div style="margin-bottom:8px;font-weight:700;color:#333;">سجلات الصيانة المرتبطة بالفاتورة</div>
        <table class="services-compact" style="width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 4px #eee;margin-bottom:12px;">
            <thead style="background:#32405a;color:#fff;">
                <tr>
                    <th style="padding:8px;text-align:right;">نوع الخدمة</th>
                    <th style="padding:8px;text-align:right;">السعر</th>
                    <th style="padding:8px;text-align:right;">تاريخ الصيانة</th>
                    <th style="padding:8px;text-align:right;">تاريخ التسليم</th>
                    <th style="padding:8px;text-align:right;">حذف</th>
                </tr>
            </thead>
            <tbody>
                {% for form in formset.forms %}
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:6px 8px;text-align:right;">{{ form.service }}</td>
                    <td style="padding:6px 8px;text-align:right;">{{ form.price }}</td>
                    <td style="padding:6px 8px;text-align:right;">{{ form.created_at }}</td>
                    <td style="padding:6px 8px;text-align:right;">{{ form.delivery_date }}</td>
                    <td style="padding:6px 8px;text-align:right;">{{ form.DELETE }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;">
            <div style="font-weight:700;color:#333;">مجموع أسعار السجلات: <span id="records-total">0.00</span></div>
            <button type="button" id="apply-total" style="background:#1976d2;color:#fff;padding:6px 12px;border:none;border-radius:6px;font-weight:bold;">تطبيق المجموع على المبلغ</button>
            <label style="margin-right:8px;display:flex;align-items:center;gap:6px;color:#555;"><input type="checkbox" id="apply-on-save"> تطبيق تلقائي عند الحفظ</label>
        </div>

        <div style="display:flex;gap:8px;align-items:center;">
            <button type="submit" style="background:#28a745;color:#fff;padding:8px 16px;border:none;border-radius:6px;font-weight:bold;">حفظ</button>
            <a href="{% url 'invoices_list' %}" style="color:#666;text-decoration:none;margin-right:6px;">إلغاء</a>
        </div>

    </form>

    <script>
    (function(){
        function parseVal(v){
            if(!v) return 0;
            v = String(v).replace(',', '.').replace(/[^0-9.\-]/g,'');
            var n = parseFloat(v);
            return isNaN(n) ? 0 : n;
        }

        var form = document.getElementById('edit-invoice-form');
        var totalEl = document.getElementById('records-total');
        var applyBtn = document.getElementById('apply-total');
        var applyOnSave = document.getElementById('apply-on-save');

        function priceInputs(){
            return Array.from(form.querySelectorAll('input[name$="-price"]'));
        }

        function calcTotal(){
            var inputs = priceInputs();
            var sum = inputs.reduce(function(acc, inp){ return acc + parseVal(inp.value); }, 0);
            totalEl.textContent = sum.toFixed(2);
            return sum;
        }

        // live update
        function bind(){
            priceInputs().forEach(function(inp){
                inp.removeEventListener('input', calcTotal);
                inp.addEventListener('input', calcTotal);
            });
        }

        // initial
        bind();
        calcTotal();

        // observe additions/removals in formset (if any)
        var tbody = form.querySelector('table.services-compact tbody');
        if(window.MutationObserver && tbody){
            var mo = new MutationObserver(function(){ bind(); calcTotal(); });
            mo.observe(tbody, { childList: true, subtree: true });
        }

        applyBtn.addEventListener('click', function(){
            var sum = calcTotal();
            var amt = form.querySelector('[name="amount"]');
            if(amt){ amt.value = sum.toFixed(2); }
        });

        form.addEventListener('submit', function(e){
            if(applyOnSave && applyOnSave.checked){
                var sum = calcTotal();
                var amt = form.querySelector('[name="amount"]');
                if(amt){ amt.value = sum.toFixed(2); }
            }
        });
    })();
    </script>
    </form>
</div>

{% endblock %}
