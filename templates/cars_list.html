{% extends 'base.html' %}
{% block content %}
<style>
  /* simplified styles for cars list */
  .cars-table { width:100%; border-collapse:collapse; font-size:15px; }
  .cars-table th, .cars-table td { padding:8px; border:1px solid #eee; text-align:center; }
  .cars-action-btn { padding:8px 16px; border-radius:6px; color:#fff; text-decoration:none; display:inline-block; }
  @media (max-width:700px) { .desktop-table { display:none; } .mobile-cards{display:block;} }
  @media (min-width:701px) { .desktop-table { display:table; } .mobile-cards{display:none;} }
</style>

<div style="max-width:1100px;margin:18px auto;padding:20px;background:#fff;border-radius:8px;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px;">
    <h2 style="margin:0;font-size:20px;">قائمة السيارات</h2>
    <div style="display:flex;gap:8px;align-items:center">
      {% if cars|length == 1 %}
        <a href="/maintenance/add/?car_id={{ cars.0.id }}" class="cars-action-btn" style="background:#007bff;">إضافة سجل صيانة</a>
      {% else %}
        <a href="/maintenance/add/" class="cars-action-btn" style="background:#007bff;">إضافة سجل صيانة</a>
      {% endif %}
      <form method="get" style="display:flex;gap:8px;align-items:center;">
        <input name="plate_number" value="{{ plate_number|default:'' }}" placeholder="رقم المركبة" style="padding:6px;border:1px solid #ccc;border-radius:4px;">
        <button class="cars-action-btn" style="background:#007bff;padding:6px 10px;border:none;">بحث</button>
      </form>
    </div>
  </div>

  {% if cars and cars|length > 0 %}
    <div class="cars-table-responsive">
      <table class="cars-table desktop-table">
        <thead>
          <tr>
            <th>رقم السيارة</th>
            <th>اسم العميل</th>
            <th>الموديل</th>
            <th>الصنع</th>
            <th>سنة</th>
            <th>الحالة</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for car in cars %}
          <tr>
            <td>
              {% if car.status == 'pending_payment' and car.unpaid_invoice_id %}
                <a href="/invoices/pay/invoice/{{ car.unpaid_invoice_id }}/">{{ car.plate_number }}</a>
              {% else %}
                {{ car.plate_number }}
              {% endif %}
            </td>
            <td>{{ car.client.first_name }}{% if car.client.last_name %} {{ car.client.last_name }}{% endif %}</td>
            <td>{% if car.model %}{{ car.model.name }}{% else %}-{% endif %}</td>
            <td>{% if car.brand %}{{ car.brand.name }}{% else %}-{% endif %}</td>
            <td>{{ car.year }}</td>
            <td>
              {% if car.has_unpaid_invoice %} معلق للدفع
              {% elif car.has_finished_maintenance %} بانتظار التسليم
              {% else %} {{ car.get_status_display }}
              {% endif %}
            </td>
            <td>
              {% if car.status == 'sold' %}
                <span style="color:#888;font-weight:bold;">تم التسليم</span>
              {% else %}
                {% if car.status == 'active' and car.has_maintenance %}
                  <form method="post" action="{% url 'cars:finish_maintenance' car.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="cars-action-btn" style="background:#ff9800;">إنهاء الصيانة</button>
                  </form>
                {% elif car.status == 'ready' %}
                  <form method="post" action="{% url 'cars:deliver_car' car.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="cars-action-btn" style="background:#28a745;">تسليم السيارة</button>
                  </form>
                {% elif car.status == 'pending_payment' and car.unpaid_invoice_id %}
                  <a href="/invoices/pay/invoice/{{ car.unpaid_invoice_id }}/" class="cars-action-btn" style="background:#e67e22;">دفع الفاتورة</a>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="mobile-cards">
        {% for car in cars %}
          <div class="mobile-card" style="border:1px solid #eee;padding:12px;border-radius:8px;margin-bottom:12px;">
            <div style="font-weight:bold;">{{ car.plate_number }}</div>
            <div style="color:#555;">{{ car.client.first_name }}{% if car.client.last_name %} {{ car.client.last_name }}{% endif %}</div>
            <div style="margin-top:8px;">
              {% if car.has_unpaid_invoice %} معلق للدفع
              {% elif car.has_finished_maintenance %} بانتظار التسليم
              {% else %} {{ car.get_status_display }}
              {% endif %}
            </div>
            <div style="margin-top:10px;">
              {% if car.status == 'active' and car.has_maintenance %}
                <form method="post" action="{% url 'cars:finish_maintenance' car.id %}">{% csrf_token %}<button class="cars-action-btn" style="background:#ff9800;width:100%">إنهاء الصيانة</button></form>
              {% elif car.status == 'ready' %}
                <form method="post" action="{% url 'cars:deliver_car' car.id %}">{% csrf_token %}<button class="cars-action-btn" style="background:#28a745;width:100%">تسليم السيارة</button></form>
              {% elif car.status == 'pending_payment' and car.unpaid_invoice_id %}
                <a href="/invoices/pay/invoice/{{ car.unpaid_invoice_id }}/" class="cars-action-btn" style="background:#e67e22;width:100%;display:inline-block;text-align:center;">دفع الفاتورة</a>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% else %}
    <div style="padding:30px;text-align:center;color:#888;">لا توجد سيارات في هذا التصنيف.</div>
  {% endif %}
</div>

{% endblock %}
