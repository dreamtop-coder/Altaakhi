<style>
.cars-mobile-wrapper {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
    box-sizing: border-box;
}

@media (max-width: 700px) {
    .cars-mobile-wrapper > * {
        width: calc(50% - 8px); /* بطاقتين */
        max-width: 50%;
        min-width: 140px;
        box-sizing: border-box;
    }
}
</style>
{% load custom_filters %}
{% if cars and cars|length > 0 %}
  <div class="cars-mobile-wrapper">
    {% for car in cars %}
      {# bookings summary (simple count + link) #}
      {% with bookings=bookings_per_phone|get_item:car.client.phone_number %}
        {% if bookings %}
          <div style="width:100%;display:flex;justify-content:flex-end;margin-bottom:6px;">
            <a href="/bookings/?phone={{ car.client.phone_number }}" title="استعراض الحجوزات" style="color:#007bff;font-size:1.05em;display:flex;align-items:center;gap:6px;">
              <i class="fa fa-calendar-plus"></i>
              <span style="background:#dc3545;color:#fff;font-size:0.75em;padding:2px 6px;border-radius:12px;font-weight:bold;">{{ bookings|length }}</span>
            </a>
          </div>
        {% endif %}
      {% endwith %}

      {# Ready: show deliver button #}
      {% if car.status == 'ready' %}
        <form method="post" action="/cars/deliver/{{ car.id }}/" style="width:100%;">
          {% csrf_token %}
          <div style="border:1px solid #28a745;padding:18px 24px;border-radius:12px;min-width:180px;display:flex;flex-direction:column;align-items:center;background:#eaffea;transition:box-shadow 0.2s;">
            <img src="{% static 'car-repair.png' %}" alt="car" style="width:48px;height:48px;margin-bottom:10px;" />
            <a href="/cars/?plate_number={{ car.plate_number }}" style="font-weight:bold;font-size:1.08em;margin-bottom:2px;direction:ltr;text-decoration:underline;color:#222;">{{ car.plate_number }}</a>
            <div style="color:#555;font-size:1em;margin-bottom:2px;">{{ car.client.first_name }}{% if car.client.last_name %} {{ car.client.last_name }}{% endif %}</div>
            <button type="submit" style="margin-top:14px;padding:8px 18px;background:#28a745;color:#fff;border:none;border-radius:6px;font-weight:bold;font-size:1.05em;cursor:pointer;box-shadow:0 2px 8px #28a74533;">تسليم السيارة</button>
            <div style="margin-top:8px;color:#28a745;font-weight:bold;">جاهزة للتسليم</div>
          </div>
        </form>

      {# Pending payment: show a simple card (no pay UI here) #}
      {% elif car.status == 'pending_payment' %}
        <div style="border:1px solid #f0ad4e;padding:18px 24px;border-radius:12px;min-width:180px;display:flex;flex-direction:column;align-items:center;background:#fffdea;transition:box-shadow 0.2s;">
          <img src="{% static 'car-repair.png' %}" alt="car" style="width:48px;height:48px;margin-bottom:10px;" />
          <a href="/cars/?plate_number={{ car.plate_number }}" style="font-weight:bold;font-size:1.08em;margin-bottom:2px;direction:ltr;text-decoration:underline;color:#222;">{{ car.plate_number }}</a>
          <div style="margin-top:8px;color:#f0ad4e;font-weight:bold;">معلق للدفع</div>
        </div>

      {# Delivered: link to client #}
      {% elif car.status == 'delivered' %}
        <a href="/clients/{{ car.client.id }}/" style="text-decoration:none;">
          <div style="border:1px solid #e0e0e0;padding:18px 24px;border-radius:12px;min-width:180px;display:flex;flex-direction:column;align-items:center;background:#fff;transition:box-shadow 0.2s;cursor:pointer;">
            <img src="{% static 'car-repair.png' %}" alt="car" style="width:48px;height:48px;margin-bottom:10px;" />
            <div style="font-weight:bold;font-size:1.08em;margin-bottom:2px;direction:ltr;">{{ car.plate_number }}</div>
            <div style="color:#555;font-size:1em;margin-bottom:2px;">{{ car.client.first_name }}{% if car.client.last_name %} {{ car.client.last_name }}{% endif %}</div>
          </div>
        </a>

      {# Default card: show plate and add maintenance when active #}
      {% else %}
        <div style="border:1px solid #e0e0e0;padding:18px 24px;border-radius:12px;min-width:180px;display:flex;flex-direction:column;align-items:center;background:#fff;transition:box-shadow 0.2s;cursor:pointer;">
          <a href="/cars/?plate_number={{ car.plate_number }}" style="text-decoration:none;">
            <img src="{% static 'car-repair.png' %}" alt="car" style="width:48px;height:48px;margin-bottom:10px;" />
            <div style="font-weight:bold;font-size:1.08em;margin-bottom:2px;direction:ltr;">{{ car.plate_number }}</div>
          </a>
          <div style="color:#555;font-size:1em;margin-bottom:2px;">{{ car.client.first_name }}{% if car.client.last_name %} {{ car.client.last_name }}{% endif %}</div>

          {% if car.status == 'active' %}
            <a href="/maintenance/add/?car_id={{ car.id }}" class="btn btn-primary btn-sm" style="margin-top:10px;">إضافة سجل صيانة</a>
          {% endif %}

          {# If this car has no maintenance records (waiting) and user filtered by plate, allow deleting the car only (not the client) #}
          {% if not car.has_maintenance and plate_number %}
            <form method="post" action="{% url 'cars:delete_car' car.id %}" style="margin-top:8px;">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger btn-sm">حذف المركبة</button>
            </form>
          {% endif %}
        </div>
      {% endif %}
    {% endfor %}
  </div>
{% else %}
  <div style="padding:30px;text-align:center;color:#888;">لا توجد سيارات في هذا التصنيف.</div>
{% endif %}
